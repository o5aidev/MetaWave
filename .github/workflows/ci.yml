
name: iOS CI

on:
  push:
    branches: [ main, develop, feature/**, fix/**, ci/** ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-latest

    concurrency:
      group: ios-ci-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4.0"

      - name: Install Bundler dependencies
        if: ${{ hashFiles('Gemfile') != '' }}
        run: bundle install --path vendor/bundle

      - name: Install CocoaPods (if needed)
        if: ${{ hashFiles('Podfile') != '' }}
        run: pod install

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Show available destinations
        working-directory: MetaWave
        run: xcodebuild -project MetaWave.xcodeproj -scheme MetaWave -showdestinations

      - name: Build
        working-directory: MetaWave
        run: |
          set -o pipefail
          set -x
          # Try to get simulator ID from xcrun simctl first (more reliable)
          echo "=== Fetching available simulators from xcrun simctl ==="
          SIM_LIST=$(xcrun simctl list devices available)
          echo "Full simulator list:"
          echo "$SIM_LIST"
          SIM_OUTPUT=$(echo "$SIM_LIST" | grep -i "iPhone" | head -1)
          echo "First iPhone simulator line: '$SIM_OUTPUT'"
          # Extract UUID from format like "iPhone 16 (0F6A0D63-B1F4-4F46-8021-E86CE5FB0ECF)"
          DEST=$(echo "$SIM_OUTPUT" | sed -nE 's/.*\(([A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12})\).*/\1/p')
          echo "Extracted destination ID from xcrun simctl: '$DEST'"
          # If empty, try xcodebuild -showdestinations as fallback
          if [ -z "$DEST" ]; then
            echo "=== xcrun simctl returned no iPhone, trying xcodebuild -showdestinations ==="
            DEST_OUTPUT=$(xcodebuild -project MetaWave.xcodeproj -scheme MetaWave -showdestinations 2>&1)
            echo "Destinations output:"
            echo "$DEST_OUTPUT"
            # Extract first iOS Simulator ID (excluding placeholders and macOS)
            DEST=$(echo "$DEST_OUTPUT" | grep "platform:iOS Simulator" | grep -v "placeholder" | grep -v "platform:macOS" | head -1 | sed -nE 's/.*id:([A-F0-9-]+).*/\1/p' | tr -d ' ')
            echo "Extracted destination ID from xcodebuild: '$DEST'"
          fi
          if [ -z "$DEST" ]; then
            echo "ERROR: No simulator destination found"
            exit 1
          fi
          echo "=== Using destination: platform=iOS Simulator,id=$DEST ==="
          if xcodebuild -project MetaWave.xcodeproj \
            -scheme "MetaWave" \
            -configuration Debug \
            -destination "platform=iOS Simulator,id=$DEST" \
            build 2>&1 | tee build.log; then
            echo "✅ Build succeeded"
          else
            echo "❌ Build failed. Full build log:"
            cat build.log
            exit 1
          fi

      - name: Check if test target exists
        working-directory: MetaWave
        id: check_test_target
        run: |
          # Check if scheme file has test entries configured
          if grep -q "<TestableReference" MetaWave.xcodeproj/xcshareddata/xcschemes/MetaWave.xcscheme 2>/dev/null; then
            echo "test_target_exists=true" >> $GITHUB_OUTPUT
            echo "✅ Test targets found in scheme"
          else
            echo "test_target_exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ No test targets configured in scheme - tests will be skipped"
          fi

      - name: Test
        working-directory: MetaWave
        if: steps.check_test_target.outputs.test_target_exists == 'true'
        run: |
          set -o pipefail
          set -x
          # Try to get simulator ID from xcrun simctl first (more reliable)
          echo "=== Fetching available simulators from xcrun simctl ==="
          SIM_LIST=$(xcrun simctl list devices available)
          echo "Full simulator list:"
          echo "$SIM_LIST"
          SIM_OUTPUT=$(echo "$SIM_LIST" | grep -i "iPhone" | head -1)
          echo "First iPhone simulator line: '$SIM_OUTPUT'"
          # Extract UUID from format like "iPhone 16 (0F6A0D63-B1F4-4F46-8021-E86CE5FB0ECF)"
          DEST=$(echo "$SIM_OUTPUT" | sed -nE 's/.*\(([A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12})\).*/\1/p')
          echo "Extracted destination ID from xcrun simctl: '$DEST'"
          # If empty, try xcodebuild -showdestinations as fallback
          if [ -z "$DEST" ]; then
            echo "=== xcrun simctl returned no iPhone, trying xcodebuild -showdestinations ==="
            DEST_OUTPUT=$(xcodebuild -project MetaWave.xcodeproj -scheme MetaWave -showdestinations 2>&1)
            echo "Destinations output:"
            echo "$DEST_OUTPUT"
            # Extract first iOS Simulator ID (excluding placeholders and macOS)
            DEST=$(echo "$DEST_OUTPUT" | grep "platform:iOS Simulator" | grep -v "placeholder" | grep -v "platform:macOS" | head -1 | sed -nE 's/.*id:([A-F0-9-]+).*/\1/p' | tr -d ' ')
            echo "Extracted destination ID from xcodebuild: '$DEST'"
          fi
          if [ -z "$DEST" ]; then
            echo "ERROR: No simulator destination found"
            exit 1
          fi
          echo "=== Using destination: platform=iOS Simulator,id=$DEST ==="
          if xcodebuild -project MetaWave.xcodeproj \
            -scheme "MetaWave" \
            -configuration Debug \
            -destination "platform=iOS Simulator,id=$DEST" \
            test 2>&1 | tee test.log; then
            echo "✅ Tests succeeded"
          else
            echo "❌ Tests failed. Full test log:"
            cat test.log
            exit 1
          fi

      - name: Skip tests (no test target)
        working-directory: MetaWave
        if: steps.check_test_target.outputs.test_target_exists != 'true'
        run: |
          echo "⚠️ Skipping tests: No test target configured in the project"
          echo "To enable tests, add a test target to the MetaWave scheme in Xcode"

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            MetaWave/build.log
            MetaWave/test.log
          if-no-files-found: ignore

      - name: Archive DerivedData logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-logs
          path: ~/Library/Logs/DiagnosticReports
          if-no-files-found: ignore
